# mysql-bash-partitioning
Скрипт для автоматического создания партиций по дням в MySQL 5.6+ для Zabbix v3.2 и выше.

# Описание
После каждой установки Zabbix, лучше сразу провести партиционирование таблиц с данными истории для более гибкого управления.

Скрипт создаёт:
- партиции по дням как для таблиц с уже существующими данными, так и для пустых;
- таблицы в MySQL для управления партициями;
- заполняет таблицы информацией для хранения партиций согласно значениям из переменных;
- создаёт процедуры MySQL по созданию и удалению партиций;
- создаёт планировщик для автоматического запуска.

# Таблицы, подлежащие партиционированию:
history
history_uint
history_str
history_text
history_log
trends
trends_uint

# Требования для успешного выполнения скрипта
0) Доступ в MySQL без ввода пароля для пользователя, от которого будет запускаться скрипт (или же поправить в самом скрипте доступ)
1) Возможность записи в директорию /tmp для хранения промежуточных данных с SQL-запросами
2) Заполненные переменные history_..._cnt и trends_cnt для нужного времени хранения партиций каждой партиционируемой таблицы. По умолчанию значения уже заданы, подлежат изменению
3) Включенный планировщик в my.cnf или через SET GLOBAL event_scheduler = ON (надо прописать в конфиг);
4) Заполненная переменная evnt_start с датой и временем запуска планировщика в MySQL. По умолчанию также уже заполнена.
5) Кодировка БД и сервера utf8 и представление utf8_general_ci по умолчанию.

# После выполнения скрипта
Отключить хаускипер в веб-интерфейсе забикса для истории и динамики изменений.

# Примечания
Не забывайте сделать бэкап всего и вся! Перед выполнением стоит понимать, что такое партиции и как они создаются. Моя статья по ручному созданию партиций с комментариями: https://it-lux.ru/mysql-%d0%bf%d0%b0%d1%80%d1%82%d0%b8%d1%86%d0%b8%d0%be%d0%bd%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86-zabbix/

Насчёт кодировок и представлений. По умолчанию процедуры создаются с представлением utf8_general_ci и если база и сервер в иной кодировке, возникнет ошибка "ERROR 1267 (HY000): Illegal mix of collations (utf8_general_ci,IMPLICIT) and (utf8_unicode_ci,IMPLICIT) for operation '=' " при вызове процедур. Я менял кодировки и представления базы, сервера, таблиц и процедур на utf8_unicode_ci, но в таком случае всё равно возникала эта ошибка (для MySQL 5.7.26, на других версихя не проверял), поэтому данный скрипт сработает без ошибок только для представления utf8_general_ci и MySQL 5.7.26
